<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Darts Scoreboard</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>

<div class="container">

    <h1>Darts Scoreboard</h1>

    <div id="game-info" class="alert alert-info hidden" role="alert">
        <h4 id="game-type"></h4>
        <p id="game-desc"></p>
    </div>

    <div id="step-1">
        <p>You can choose a currently active game here:</p>

        <p>
            <select id="active-games" class="form-control"></select>
        </p>

        <button id="show-scoreboard" class="btn btn-success" disabled>Show scoreboard</button>
    </div>

    <div id="step-2" class="hidden">

        <h3>Players:</h3>

        <div id="scoreboard-data"></div>

        <div class="clearfix"></div>

        <hr>

        <button id="close-game" class="btn btn-default">Close game</button><br><br>

    </div>

    <div id="step-3" class="hidden">

        <h4>Game successfully closed.</h4>

    </div>

</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script type="text/javascript">

    var baseUrl = 'http://10.27.7.41:660/';

    var activeGameTemplate = function(id, created, name) {
        return '<option value="'+id+'">'+created+' - '+name+'</option>';
    };

    var playerTemplate = function(id, name, scores) {
        var results = '';
        var points = 301;
        var panelClass = 'panel-default';

        scores.forEach(function(item, index) {
            if (points - item.score < 0) {
                results += '<p style="text-decoration: line-through; font-weight: bold; color: red;">' +
                '<b>#'+(index+1)+' </b> Score: '+item.score+'</p>';
            }
            else if (points - item.score === 0) {
                points = 'WIN!';
                results += '<p><b>#'+(index+1)+' </b> Score: '+item.score+'</p>';
                panelClass = 'panel-danger';
                return;
            }
            else {
                results += '<p><b>#'+(index+1)+' </b> Score: '+item.score+'</p>';
                points -= item.score;
            }
        });

        var beginning =
                '<div class="col-xs-12 col-sm-4 col-md-3">' +
                '<div id="player-'+id+'" class="panel '+panelClass+'">' +
                '<div class="panel-heading">' +
                '<h3 class="panel-title" style="overflow:hidden;font-weight:bold;font-size:2em;">'+name+'' +
                '<span class="badge pull-right" style="font-size: 32px;padding: 8px">'+points+'</span></h3></div>' +
                '<div class="panel-body">';

        return beginning + results + '</div></div></div>';
    };

    $(document).ready(function() {

        var games = $.get(baseUrl + 'games');
        games.done(function(data) {
            data.forEach(function(item) {
                $('#active-games').append(activeGameTemplate(item.id, item.created_at, item.game_type.description));
            });

            if (data.length > 0)
                $('#show-scoreboard').prop('disabled', false);
        });
        games.fail(function() {
            alert('Oooops, there was an error!!');
        });

    });

    $('#show-scoreboard').click(function() {
        var result = refreshScoreBoard();

        if (result) {
            setInterval(refreshScoreBoard, 1000);

            $('#step-1').addClass('hidden');
            $('#step-2').removeClass('hidden');

            var game = $.get(baseUrl + 'games/' + $('#active-games').val());
            game.done(function(data) {
                $('#game-type').text(data.game_type.name);
                $('#game-desc').text(data.game_type.description);
                $('#game-info').removeClass('hidden');
            });
        }

    });
    
    $('#close-game').click(function() {
        var game = $.post(baseUrl + 'games/' + $('#active-games').val() + '/close');
        game.done(function() {
            $('#step-2').addClass('hidden');
            $('#step-3').removeClass('hidden');
        });
        games.fail(function() {
            alert('Oooops, there was an error!!');
        });
    });

    var refreshScoreBoard = function() {
        var gameId = $('#active-games').val();
        var players = $.get(baseUrl + 'players?game_id=' + gameId);

        var success = true;

        players.done(function(data) {
            var html = '';
            var scoreBoardData = $('#scoreboard-data');

            var latest = [0, 0]; // player, score

            data.forEach(function(item) {
                html += playerTemplate(item.id, item.name, item.scores);
                if (item.scores.length > 0) {
                    var scoreId = item.scores[item.scores.length - 1].id;
                    if (scoreId > latest[1]) {
                        latest[0] = item.id;
                        latest[1] = scoreId;
                    }
                }
            });

            if (scoreBoardData.html() !== html) {
                scoreBoardData.html(html);

                $('.panel').removeClass('panel-success').addClass('panel-default');
                $('#player-' + latest[0]).removeClass('panel-default').addClass('panel-success');
            }
        });
        players.fail(function() {
            success = false;
            alert('Oooops, there was an error!!');
        });

        return success;
    }

</script>

</body>
</html>