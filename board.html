<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Darts Scoreboard</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>

<div class="container">

    <h1>Darts Scoreboard</h1>

    <h2 id="game-type" class="hidden"></h2>
    <p id="game-desc" class="hidden"></p>

    <div id="step-1">
        <p>You can choose a currently active game here:</p>

        <p>
            <select id="active-games" class="form-control"></select>
        </p>

        <button id="show-scoreboard" class="btn btn-success" disabled>Show scoreboard</button>
    </div>

    <div id="step-2" class="hidden">

        <h3>Players:</h3>

        <div id="scoreboard-data"></div>

        <div class="clearfix"></div>

        <hr>

        <button id="close-game">Close game</button><br><br>

    </div>

    <div id="step-3" class="hidden">

        <h4>Game successfully closed.</h4>

    </div>

</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script type="text/javascript">

    var activeGameTemplate = function(id, created, name) {
        return '<option value="'+id+'">'+created+' - '+name+'</option>';
    };

    var playerTemplate = function(name, scores) {
        var results = '';
        var points = 301;
        scores.forEach(function(item, index) {
            results += '<p><b>#'+(index+1)+' </b> Score: '+item.score+'</p>';
            points -= item.score;
        });

        var beginning =
                '<div class="col-xs-12 col-sm-6 col-md-4">' +
                '<div class="panel panel-default">' +
                '<div class="panel-heading">' +
                '<h3 class="panel-title">'+name+'' +
                '<span class="badge pull-right">'+points+'</span></h3></div>' +
                '<div class="panel-body">';

        return beginning + results + '</div></div></div>';
    };

    $(document).ready(function() {

        var games = $.get('http://darts24-backend/games');
        games.done(function(data) {
            data.forEach(function(item) {
                $('#active-games').append(activeGameTemplate(item.id, item.created_at, item.game_type.description));
            });

            if (data.length > 0)
                $('#show-scoreboard').prop('disabled', false);
        });
        games.fail(function() {
            alert('Oooops, there was an error!!');
        });

    });

    $('#show-scoreboard').click(function() {
        var result = refreshScoreBoard();

        if (result) {
            setInterval(refreshScoreBoard, 1000);

            $('#step-1').addClass('hidden');
            $('#step-2').removeClass('hidden');

            var game = $.get('http://darts24-backend/games/' + $('#active-games').val());
            game.done(function(data) {
                $('#game-type').text(data.game_type.name).removeClass('hidden');
                $('#game-desc').text(data.game_type.description).removeClass('hidden');
            });
        }

    });
    
    $('#close-game').click(function() {
        var game = $.post('http://darts24-backend/games/' + $('#active-games').val() + '/close');
        game.done(function() {
            $('#step-2').addClass('hidden');
            $('#step-3').removeClass('hidden');
        });
        games.fail(function() {
            alert('Oooops, there was an error!!');
        });
    });

    var refreshScoreBoard = function() {
        var gameId = $('#active-games').val();
        var players = $.get('http://darts24-backend/players?game_id=' + gameId);

        var success = true;

        players.done(function(data) {
            var html = '';
            var scoreBoardData = $('#scoreboard-data');

            data.forEach(function(item) {
                html += playerTemplate(item.name, item.scores);
            });

            if (scoreBoardData.html() !== html) {
                scoreBoardData.html(html);
            }
        });
        players.fail(function() {
            success = false;
            alert('Oooops, there was an error!!');
        });

        return success;
    }

</script>

</body>
</html>